# AIDECK V1 自定义框架 (Custom Style) 功能流程详解

本文档详细解释了 AIDECK V1 如何将用户上传的文件或文本描述转化为一个全新的、定制化的咨询顾问 AI 人格。

## 1. 核心流程图 (Process Flowchart)

```ascii
+-------------------------------------------------------+
|                  1. 用户输入 (User Input)              |
|                                                       |
|  [ 上传参考文件 ]       或       [ 输入文字描述 ]        |
| (PDF / 图片 / 风格指南)        (例如："赛博朋克极简风")   |
+---------------------------+---------------------------+
                            |
                            v
+-------------------------------------------------------+
|               2. AI 反向工程 (Reverse Engineering)     |
|           函数: services/geminiService.ts             |
|              -> extractCustomStyle()                  |
|                                                       |
|  [Gemini 3 Pro] 扮演 "方法论工程师" & "设计总监"        |
|  任务: 分析输入内容，提取逻辑架构和视觉DNA               |
+---------------------------+---------------------------+
                            |
                            v
+-------------------------------------------------------+
|             3. 生成系统提示词 (System Prompts)          |
|           (生成两个核心 JSON 对象，存入 React State)    |
|                                                       |
|  A. CORE_PROMPT (逻辑脑)   |   B. VISUAL_PROMPT (画师) |
|  -----------------------  |   ----------------------- |
|  - 定义顾问角色 (Persona)  |   - 定义配色 (Hex Codes)  |
|  - 定义叙事结构 (SCQA)     |   - 定义排版栅格 (Layout) |
|  - 定义图表库偏好          |   - 定义绘图风格 (Style)  |
+---------------------------+---------------------------+
                            |
                            v
+-------------------------------------------------------+
|              4. 提示词注入 (Prompt Injection)          |
|              函数: constants.ts -> getSystemPrompts   |
|                                                       |
|      [ 替换标准 McKinsey/BCG 模版 -> 注入自定义模版 ]    |
+---------------------------+---------------------------+
                            |
                            v
+-------------------------------------------------------+
|                5. 幻灯片生成循环 (Deck Generation)     |
+---------------------------+---------------------------+
|                           |                           |
|   [ 生成大纲 ] <-----------+   [ 生成单页逻辑 ]         |
|   (使用自定义逻辑)              (使用自定义语气/结构)     |
|                           |                           |
|                           v                           |
|                   [ 生成视觉画面 ]                     |
|             (Gemini 绘画时严格遵守自定义配色/布局)       |
+-------------------------------------------------------+
```

---

## 2. 详细步骤解释

### 第一阶段：提取 (Extraction)
**目的**：让 AI 理解用户想要什么风格，而不是仅仅根据关键词瞎猜。

1.  **用户操作**：在风格选择页面点击 "Custom"，上传一份 PDF 风格指南（比如某公司的内部分享材料）或者输入一段详细的描述（比如“深色背景，霓虹配色，科技感”）。
2.  **API 调用**：前端调用 `extractCustomStyle`。
3.  **AI 分析**：
    *   Gemini 3.0 Pro 被唤醒。
    *   它会分析上传的图片/PDF，提取其中的 **颜色代码 (Hex Codes)**、**字体风格**、**图表类型** 以及 **行文语气**。
    *   它不仅仅是“看”，而是被要求“反向编写”一份系统提示词（System Prompt）。

### 第二阶段：定义 (Definition)
**目的**：将模糊的风格转化为代码可执行的指令。

AI 会返回一个包含两个部分的 JSON 对象：
*   **`core` (逻辑核)**：定义了这个“新顾问”是谁。例如，如果用户上传了阿里的汇报材料，这个提示词会定义“你是一个阿里P8级专家，使用倒金字塔逻辑，强调赋能和闭环”。
*   **`visual` (视觉核)**：定义了“新设计师”的规范。例如，“背景必须是纯黑 (#000000)，强调色使用阿里橙 (#FF5000)，禁止使用阴影”。

### 第三阶段：注入与执行 (Injection & Execution)
**目的**：让整个生成引擎切换到新的人格。

1.  **状态存储**：React 将这两个提示词保存在 `customStylePrompts` 状态中。
2.  **动态替换**：
    *   当系统开始生成大纲 (`generateOutline`) 或生成具体页面 (`generateSlideContent`) 时，会调用 `getSystemPrompts`。
    *   代码逻辑：`if (style === 'custom') { use(customPrompts) }`。
    *   这意味着后续所有的 AI 调用（无论是写字还是画图），都在严格执行用户刚刚定义的那个“新角色”的指令。

## 3. 关键代码逻辑映射

*   **入口**：`App.tsx` -> `handleAnalyzeCustomStyle`
*   **大脑**：`services/geminiService.ts` -> `extractCustomStyle` (这里定义了如何去“抄”风格)
*   **路由**：`constants.ts` -> `getSystemPrompts` (这里决定了是使用麦肯锡模版还是用户自定义模版)

通过这个流程，AIDECK V1 实现了真正的“千人千面”，不再局限于预设的三大咨询公司风格。
