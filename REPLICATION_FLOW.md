# 1:1 完美幻灯片复刻协议 (Project Iron)

## 🎯 核心目标
实现从静态 PDF 到可编辑 PPTX 的 **像素级（1:1）完美复刻**。确保生成的 PPTX 如果再次导出为图片，能与原始 PDF 图片完全重合，无位置偏移。

## 🏗 架构流程图 (ASCII)

```ascii
[ 原始 PDF ] 
      │
      ▼
[ 栅格化渲染器 ] -> (生成 4K 图片 @ 16:9 比例)
      │
      ├───> [ 图像处理管线 (智能循环) ] ─────────────────────┐
      │     │                                                │
      │     ▼                                                │
      │   [ AI 智能去除 (Gemini 3 Pro) ]                     │
      │   "仅删除文字像素，保持所有结构元素位置固定"           │
      │     │                                                │
      │     ▼ ◄──────────────────────────────────────────┐   │
      │   (候选背景图)                                   │   │
      │     │                                            │   │
      │     ▼                                            │   │
      │   [ AI 质检员 (Gemini 2 Flash) ] ────────────────┘   │
      │   "还有文字吗？在哪里？(Feedback Loop)"              │
      │     │                                                │
      │     ▼ (通过)                                         │
      │   (最终纯净背景层)                                   │
      │   包含：形状、图标、线条、照片、渐变                 │
      │   不含：所有印刷文字、符号、数字                     │
      │     │                                                │
      │     └───────────────────────┐                        │
      │                             ▼                        │
      │                       [ PPTX 合成器 ] <──────────────┘
      │                       画布：16:9 (10" x 5.625")
      │                       第 0 层：纯净背景图 (作为底层)
      │                       第 1 层：透明文本框 (精准覆盖)
      │                             ▲
      │                             │
      ├───> [ 数据处理管线 ] ──────┘
      │     │
      │     ▼
      │   [ 空间 OCR (阿里云) ]
      │   返回：{ 文本, 坐标框: [y1,x1,y2,x2] (0-1000 归一化刻度) }
      │     │
      │     ▼
      │   [ 坐标归一化处理器 ]
      │   逻辑：将相对刻度 (0-1000) 转换为 百分比 (%)
      │   优势：百分比逻辑比绝对尺寸更具鲁棒性，无视 DPI 差异
      │     │
      │     ▼
      │   [ 排版拟合引擎 ]
      │   约束：文字必须精确填入 OCR 识别出的方框内
      │   数学公式：字号 (FontSize) = 框高度 * 0.78 (黄金比例修正)
      │   对齐：垂直居中 (Middle) (用于对冲不同字体的渲染微差)
      │   边距：0.0 (强制零内边距 Inset)
```

## 📐 保证精准的三大支柱

### 1. 锚定图层策略 (Anchor Layer Strategy)
我们不尝试重新绘制形状（那会产生误差），而是将幻灯片视为两个图层：
- **第 0 层（锚点）：** 一张包含 *除文字外所有内容* 的高保真图片。这保证了线条、复杂的架构图、照片位置与原件 **100% 相同**，因为它们本质上就是原图。
- **第 1 层（数据）：** 漂浮在背景上的透明文本框，精确覆盖在原先文字所在的像素位置。

### 2. 闭环质量验证 (Closed-Loop Verification)
为了确保背景图绝对干净（防止“鬼影”文字），我们引入了 **AI 质检员**：
- **生成 (Painter):** 初步移除 OCR 识别到的文字。
- **检查 (Inspector):** 使用视觉大模型扫描图片，寻找遗漏的汉字、数字或符号。
- **修正 (Refiner):** 如果发现遗漏，将具体坐标反馈给生成器进行第二轮“定点清除”。
- **结果:** 只有通过质检的图片才会进入最终合成。

### 3. 排版拟合逻辑 (Typography Fitting)
这是复刻中最难的部分。PDF 文字是“描绘”出来的，而 PPT 文字是“渲染”出来的。
为了消除漂移：

*   **零内边距 (Zero Inset)：** PPT 默认会添加 0.1 英寸的边距。我们强制设置 `inset: 0`，使文字边缘直接触碰 OCR 识别出的边界框。
*   **垂直锚定 (Vertical Anchor)：** 我们使用 `valign: "middle"` (垂直居中)。
    *   *原理：* 如果字号有极细微的差别（例如 Arial 和微软雅黑的渲染高度不同），“置顶”对齐会导致误差向下累积。而“居中”对齐会将误差平分，确保文字的视觉重心始终锁定在原始位置。
*   **行高修正 (Line-Height Correction)：**
    *   OCR 的“框高度” = 文字高度 + 行间距。
    *   PPT 的“字号” = 仅文字本身高度。
    *   **计算公式：** `FontSize = 框高度 * 0.78`。这个 0.78 的系数修正了 OCR 框内包含的空白区域，防止文字在 PPT 中因“过大”而溢出。

## 📝 校验清单 (完美复刻测试)

在处理每一张幻灯片时，系统逻辑会自动检查：

1.  **背景是否纯净？** (Gemini 2 Flash 自动审核通过)。
2.  **坐标是否线性？** (左对齐的文字必须共享完全相同的 X 百分比值)。
3.  **是否强制换行？** (如果 OCR 检测到多行，PPT 文本框的宽度将强制触发相同的换行逻辑)。

## 🚀 当前代码执行状态

1.  **OCR 服务 (`server.cjs`)：** 已配置为 0-1000 归一化输出。**已完成**。
2.  **AI 修补 (`nanobananaService`)：** 已升级为“生成-检查-修正”闭环模式。**已完成**。
3.  **PPT 合成器 (`pptGenService`)：**
    *   `inset: 0` (已启用)
    *   `valign: middle` (已启用)
    *   `layout: 16x9` (已启用)
    *   `字号计算系数` (已调优至 0.78)

这套逻辑设计为“安全失败”模式：即使字体库有细微不同，由于**文本框（Box）**被锁定在原始百分比坐标上，整体结构仍能保证 1:1 不乱序。
